<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinal de Pre√ßos - Pro Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #161b22; border: 1px solid #30363d; color: #c9d1d9; }
        .table { color: #c9d1d9; border-color: #30363d; }
        .table-hover tbody tr:hover { background-color: #1f2937; color: #fff; }
        .progress { background-color: #30363d; height: 8px; }
        .text-success-bright { color: #39d353 !important; }
        .text-danger-bright { color: #ff7b72 !important; }
        .text-warning-soft { color: #ffab70 !important; }
        .badge-buy { background-color: #238636; color: white; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">üìä Monitor de Ativos <span class="text-primary">B3</span></h2>
        <span class="badge bg-dark border border-secondary">Status: Bot Online</span>
    </div>

    <div class="card shadow-lg">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead style="background-color: #21262d;">
                        <tr>
                            <th class="ps-4 py-3">Ativo</th>
                            <th>Tipo</th>
                            <th>Qtd</th>
                            <th class="py-3">Pre√ßo Atual</th>
                            <th class="py-3">P/VP</th>
                            <th class="py-3">Varia√ß√£o (%)</th>
                            <th class="py-3">Lucro/Prej. (R$)</th>
                            <th class="py-3">Dist√¢ncia do Alvo</th>
                            <th class="py-3">Pre√ßo Teto</th>
                            <th class="py-3">Magic Number (Bola de Neve)</th>
                            <th class="py-3 text-center">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fii in fundos %}
                        {% if fii.quantidade > 0 %}
                        <tr>
                            <td><strong>{{ fii.ticker }}</strong></td>
                            <td>
                                <span class="badge
                                    {% if fii.tipo == 'Papel' %}bg-secondary
                                    {% elif fii.tipo == 'Tijolo' %}bg-primary
                                    {% elif fii.tipo == 'Fof' %}bg-info
                                    {% else %}bg-dark{% endif %}">
                                    {{ fii.tipo|default:"Tijolo"|capfirst }}
                                </span>
                            </td>
                            <td>{{ fii.quantidade }}</td>

                            <td>
                                <span class="fw-bold">R$ {{ fii.preco_atual }}</span>
                                {% if fii.quantidade > 0 %}
                                    <br>
                                    <small style="font-size: 0.75rem;"
                                           class="{% if fii.preco_atual < fii.preco_medio %}text-warning-soft{% else %}text-muted{% endif %}">
                                        M√©dio: R$ {{ fii.preco_medio|stringformat:".2f" }}
                                        {% if fii.preco_atual < fii.preco_medio %}
                                            ‚ö†Ô∏è <span class="badge bg-warning text-dark" style="font-size: 0.5rem;">BAIXAR M√âDIO</span>
                                        {% endif %}
                                    </small>
                                {% endif %}
                            </td>

                            <td class="fw-bold">
                                <span class="{% if fii.p_vp > 1.05 %}text-danger-bright{% elif fii.p_vp < 1.0 %}text-success-bright{% endif %}">
                                    {{ fii.p_vp|stringformat:".2f" }}
                                </span>
                                <br>
                                <small class="text-muted" style="font-size: 0.7rem;">VP: R$ {{ fii.valor_patrimonial }}</small>
                            </td>

                            <td class="{% if fii.variacao < 0 %}text-danger-bright{% else %}text-success-bright{% endif %} fw-bold">
                                {% if fii.variacao < 0 %}üìâ{% else %}üìà{% endif %} {{ fii.variacao|stringformat:".2f" }}%
                            </td>

                            <td class="fw-bold">
                                {% if fii.quantidade > 0 %}
                                    <span class="{% if fii.lucro_total < 0 %}text-danger-bright{% else %}text-success-bright{% endif %}">
                                        R$ {{ fii.lucro_total|stringformat:".2f" }}
                                    </span>
                                {% else %}
                                    <span class="text-muted opacity-50">-</span>
                                {% endif %}
                            </td>

                            <td style="min-width: 150px;">
                                <div class="small mb-1">
                                    {% if fii.preco_atual <= fii.preco_teto %}
                                        <span class="text-success-bright">No Alvo!</span>
                                    {% else %}
                                        Faltam R$ {{ fii.falta_quanto|stringformat:".2f" }}
                                    {% endif %}
                                </div>
                                <div class="progress">
                                    <div class="progress-bar {% if fii.preco_atual <= fii.preco_teto %}bg-success{% else %}bg-primary{% endif %}"
                                         role="progressbar"
                                         style="width: {% widthratio fii.preco_teto fii.preco_atual 100 %}%">
                                    </div>
                                </div>
                            </td>

                            <td>R$ {{ fii.preco_teto }}</td>

                            <td>
                                {% if fii.ultimo_dividendo > 0 %}
                                    <div class="small mb-1">
                                        <span class="fw-bold">{{ fii.quantidade }}</span> /
                                        <span class="text-info">{{ fii.magic_number }}</span> cotas
                                    </div>

                                    <div class="progress" style="height: 10px; background-color: #30363d;">
                                        <div class="progress-bar {% if fii.progresso_magic >= 100 %}bg-success{% else %}bg-info{% endif %}"
                                             style="width: {{ fii.progresso_magic }}%;">
                                        </div>
                                    </div>

                                    <small class="text-muted" style="font-size: 0.7rem;">
                                        {% if fii.faltam_para_magic > 0 %}
                                            Faltam: <strong>{{ fii.faltam_para_magic }}</strong> para o objetivo
                                        {% else %}
                                            <span class="text-success-bright">üèÜ BOLA DE NEVE ATIVA</span>
                                        {% endif %}
                                    </small>
                                {% else %}
                                    <span class="text-muted" style="font-size: 0.8rem;">Aguardando dividendo...</span>
                                {% endif %}
                            </td>

                            <td class="text-center">
                                {% if fii.preco_atual <= fii.preco_teto %}
                                    <span class="badge badge-buy px-3 py-2">üî• COMPRAR</span>
                                {% else %}
                                    <span class="badge bg-secondary px-3 py-2 opacity-50">AGUARDAR</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="row h-100">
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm border-0 p-3 h-100">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Patrim√¥nio Alocado</small>
                    <h3 class="fw-bold mb-0 text-white">R$ {{ total_investido|floatformat:2 }}</h3>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm border-0 p-3 h-100">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Proje√ß√£o de Dividendos</small>
                    <h3 class="text-success-bright fw-bold mb-0">R$ {{ renda_estimada|floatformat:2 }}</h3>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm border-0 p-3 h-100">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Bola de Neve Ativa</small>
                    <h3 class="text-info fw-bold mb-0">{{ magic_atingidos }} <span class="text-muted" style="font-size: 1rem;">de {{ total_ativos }}</span></h3>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm border-0 p-3 h-100">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Status do Sistema</small>
                    <h3 class="text-warning-soft fw-bold mb-0" style="font-size: 1.2rem;">ONLINE ü§ñ</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card shadow-sm border-0 p-3 h-100">
            <small class="text-muted text-uppercase fw-bold mb-3" style="font-size: 0.7rem;">Diversifica√ß√£o por Setor</small>
            <div style="height: 180px;">
                <canvas id="chartDiversificacao"></canvas>
            </div>
        </div>
    </div>
</div>

    <div class="col-md-4">
        <div class="card shadow-sm border-0 p-3 h-100">
            <small class="text-muted text-uppercase fw-bold mb-3" style="font-size: 0.7rem;">Diversifica√ß√£o por Tipo</small>
            <div style="max-height: 200px;">
                <canvas id="chartDiversificacao"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('chartDiversificacao').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ labels_grafico|safe }},
            datasets: [{
                data: {{ dados_grafico|safe }},
                backgroundColor: [
                    '#39d353', // Verde (Tijolo)
                    '#2188ff', // Azul (Papel)
                    '#f1e05a', // Amarelo (Fof)
                    '#ff7b72', // Vermelho (H√≠brido)
                    '#8957e5'  // Roxo (Desenvolvimento)
                ],
                borderWidth: 0,
                cutout: '70%' // Deixa a rosca mais fina e elegante
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#c9d1d9',
                        padding: 10,
                        font: { size: 11 }
                    }
                }
            }
        }
    });
</script>
</body>
</html>